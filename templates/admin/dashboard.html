{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<style>
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-left: 4px solid #667eea;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.15);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #7f8c8d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.message-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #e74c3c;
    transition: all 0.3s ease;
}

.message-card:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.message-card.read {
    border-left-color: #28a745;
}

.chat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #17a2b8;
    transition: all 0.3s ease;
}

.chat-card:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.engagement-chart {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.quick-stats {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.stat-item:last-child {
    border-bottom: none;
}

.priority-high {
    border-left: 4px solid #dc3545 !important;
}

.priority-medium {
    border-left: 4px solid #ffc107 !important;
}

.priority-low {
    border-left: 4px solid #28a745 !important;
}

.status-new {
    background: #dc3545;
    color: white;
}

.status-pending {
    background: #ffc107;
    color: #212529;
}

.status-responded {
    background: #28a745;
    color: white;
}

.status-closed {
    background: #6c757d;
    color: white;
}
</style>

<div class="dashboard-header">
    <div class="container">
        <h1 class="mb-0">Admin Dashboard</h1>
        <p class="mb-0 opacity-75">Real-time engagement monitoring and message management</p>
    </div>
</div>

<div class="container">
    <!-- Quick Stats -->
    <div class="quick-stats">
        <h5 class="mb-3">Quick Overview</h5>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <span>Total Messages</span>
                    <strong>{{ total_messages }}</strong>
                </div>
                <div class="stat-item">
                    <span>Unread</span>
                    <strong class="text-danger">{{ unread_messages }}</strong>
                </div>
                <div class="stat-item">
                    <span>Today</span>
                    <strong>{{ today_messages }}</strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span>Total Chats</span>
                    <strong>{{ total_chats }}</strong>
                </div>
                <div class="stat-item">
                    <span>Active</span>
                    <strong class="text-success">{{ active_chats }}</strong>
                </div>
                <div class="stat-item">
                    <span>Today</span>
                    <strong>{{ today_chats }}</strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span>Total Users</span>
                    <strong>{{ total_users }}</strong>
                </div>
                <div class="stat-item">
                    <span>Active</span>
                    <strong>{{ active_users }}</strong>
                </div>
                <div class="stat-item">
                    <span>New Today</span>
                    <strong>{{ new_users_today }}</strong>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span>Page Views</span>
                    <strong>{{ total_page_views }}</strong>
                </div>
                <div class="stat-item">
                    <span>Today</span>
                    <strong>{{ today_page_views }}</strong>
                </div>
                <div class="stat-item">
                    <span>Unique Visitors</span>
                    <strong>{{ unique_visitors_today }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Messages Section -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Contact Messages ({{ recent_messages|length }})</h5>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="markAllAsRead()">
                        <i class="fas fa-check-double"></i> Mark All Read
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportMessages()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            {% if recent_messages %}
                {% for message in recent_messages %}
                <div class="message-card {{ 'read' if message.is_read else '' }} priority-{{ message.priority|lower }}">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        {{ message.name }}
                                        {% if not message.is_read %}
                                            <span class="badge bg-danger ms-2">New</span>
                                        {% endif %}
                                    </h6>
                                    <p class="text-muted mb-1">{{ message.email }}</p>
                                    {% if message.phone %}
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-phone me-1"></i>{{ message.phone }}
                                    </p>
                                    {% endif %}
                                    <p class="mb-2">{{ message.message[:150] }}{% if message.message|length > 150 %}...{% endif %}</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge status-{{ message.status|lower }}">{{ message.status.title() }}</span>
                                    <br>
                                    <small class="text-muted">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" data-action="view-message" data-id="{{ message.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success" data-action="reply-message" data-id="{{ message.id }}" data-email="{{ message.email|e }}" data-name="{{ message.name|e }}">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" data-action="archive-message" data-id="{{ message.id }}">
                                    <i class="fas fa-archive"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" data-action="delete-message" data-id="{{ message.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No contact messages found</p>
                </div>
            {% endif %}
            
            {% if recent_messages|length > 0 %}
            <div class="text-center mt-3">
                <a href="{{ url_for('admin.messages') }}" class="btn btn-primary">
                    View All Messages ({{ total_messages }})
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Chatbot Messages Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Chatbot Conversations ({{ recent_chats|length }})</h5>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="exportChats()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            {% if recent_chats %}
                {% for chat in recent_chats %}
                <div class="chat-card">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        {{ chat.user_name or 'Anonymous' }}
                                        <span class="badge bg-info ms-2">{{ chat.service_requested or 'General' }}</span>
                                    </h6>
                                    <p class="text-muted mb-1">{{ chat.user_email or 'No email' }}</p>
                                    {% if chat.user_phone %}
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-phone me-1"></i>{{ chat.user_phone }}
                                    </p>
                                    {% endif %}
                                    <p class="mb-2">
                                        <strong>Last message:</strong> 
                                        {% if chat.messages %}
                                            {{ chat.messages[-1].message_text[:100] }}{% if chat.messages[-1].message_text|length > 100 %}...{% endif %}
                                        {% else %}
                                            No messages yet
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <span class="badge status-{{ chat.status|lower }}">{{ chat.status.title() }}</span>
                                    <br>
                                    <small class="text-muted">{{ chat.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info" data-action="view-chat" data-id="{{ chat.id }}">
                                    <i class="fas fa-comments"></i>
                                </button>
                                <button class="btn btn-sm btn-success" data-action="reply-chat" data-id="{{ chat.id }}" data-email="{{ chat.user_email|e if chat.user_email else '' }}" data-name="{{ chat.user_name|e if chat.user_name else 'Anonymous' }}">
                                    <i class="fas fa-reply"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" data-action="archive-chat" data-id="{{ chat.id }}">
                                    <i class="fas fa-archive"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" data-action="delete-chat" data-id="{{ chat.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No chatbot conversations found</p>
                </div>
            {% endif %}
            
            {% if recent_chats|length > 0 %}
            <div class="text-center mt-3">
                <a href="{{ url_for('admin.chatbot') }}" class="btn btn-primary">
                    View All Chats ({{ total_chats }})
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Message Detail Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Message Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reply to Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="replyForm">
                    <div class="mb-3">
                        <label for="replyTo" class="form-label">To:</label>
                        <input type="email" class="form-control" id="replyTo" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="replySubject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="replySubject">
                    </div>
                    <div class="mb-3">
                        <label for="replyMessage" class="form-label">Message:</label>
                        <textarea class="form-control" id="replyMessage" rows="6" required></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendCopy">
                            <label class="form-check-label" for="sendCopy">
                                Send copy to admin
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendReply()">
                    <i class="fas fa-paper-plane"></i> Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Detail Modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chat Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="chatModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Event delegation for all action buttons
document.addEventListener('click', function(e) {
    const button = e.target.closest('button[data-action]');
    if (!button) return;
    
    const action = button.dataset.action;
    const id = button.dataset.id;
    const email = button.dataset.email || '';
    const name = button.dataset.name || '';
    
    switch(action) {
        case 'view-message':
            window.location.href = `/admin/message/${id}`;
            break;
        case 'reply-message':
            replyToMessage(id, email, name);
            break;
        case 'delete-message':
            deleteMessage(id);
            break;
        case 'archive-message':
            archiveMessage(id);
            break;
        case 'view-chat':
            viewChat(id);
            break;
        case 'reply-chat':
            replyToChat(id, email, name);
            break;
        case 'delete-chat':
            deleteChat(id);
            break;
        case 'archive-chat':
            archiveChat(id);
            break;
    }
});

// Message functions
function replyToMessage(id, email, name) {
    document.getElementById('replyTo').value = email;
    document.getElementById('replySubject').value = `Re: Your message to Aura`;
    document.getElementById('replyMessage').value = `Dear ${name},\n\n`;
    
    const modal = new bootstrap.Modal(document.getElementById('replyModal'));
    modal.show();
}

function sendReply() {
    const formData = {
        to: document.getElementById('replyTo').value,
        subject: document.getElementById('replySubject').value,
        message: document.getElementById('replyMessage').value,
        send_copy: document.getElementById('sendCopy').checked
    };
    
    fetch('/admin/send-reply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Reply sent successfully!');
            bootstrap.Modal.getInstance(document.getElementById('replyModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function deleteMessage(id) {
    if (confirm('Are you sure you want to delete this message?')) {
        fetch(`/admin/message/${id}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                alert('Message deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting message');
            }
        });
    }
}

function archiveMessage(id) {
    fetch(`/admin/message/${id}/archive`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Message archived successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function markAllAsRead() {
    fetch('/admin/messages/mark-all-read', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('All messages marked as read!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function exportMessages() {
    window.open('/admin/messages/export', '_blank');
}

// Chat functions
function viewChat(id) {
    fetch(`/admin/chat/${id}`)
        .then(response => response.json())
        .then(data => {
            let messagesHtml = '';
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    const senderClass = msg.sender === 'user' ? 'text-primary' : 'text-success';
                    messagesHtml += `
                        <div class="mb-3">
                            <strong class="${senderClass}">${msg.sender.charAt(0).toUpperCase() + msg.sender.slice(1)}:</strong>
                            <p>${msg.message_text.replace(/\n/g, '<br>')}</p>
                            <small class="text-muted">${msg.created_at}</small>
                        </div>
                    `;
                });
            } else {
                messagesHtml = '<p class="text-muted">No messages yet</p>';
            }
            
            const modalBody = document.getElementById('chatModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>User:</h6>
                        <p>${data.user_name || 'Anonymous'}</p>
                        <p><strong>Email:</strong> ${data.user_email || 'Not provided'}</p>
                        ${data.user_phone ? `<p><strong>Phone:</strong> ${data.user_phone}</p>` : ''}
                        <p><strong>Service:</strong> ${data.service_requested || 'General'}</p>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Created:</strong> ${data.created_at}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Conversation:</h6>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 1rem; border-radius: 8px;">
                            ${messagesHtml}
                        </div>
                    </div>
                </div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('chatModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading chat:', error);
            alert('Error loading chat conversation');
        });
}

function replyToChat(id, email, name) {
    if (!email) {
        alert('No email address available for this user');
        return;
    }
    replyToMessage(id, email, name);
}

function deleteChat(id) {
    if (confirm('Are you sure you want to delete this chat conversation?')) {
        fetch(`/admin/chat/${id}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Chat deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function archiveChat(id) {
    fetch(`/admin/chat/${id}/archive`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Chat archived successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function exportChats() {
    window.open('/admin/chats/export', '_blank');
}
</script>
{% endblock %}
